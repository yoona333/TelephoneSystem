<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>通话管理系统</title>
    <style>
        body {
            font-family: 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: black;
            color: white;
        }
        h2 {
            color: white;
            text-align: center;
            margin-bottom: 20px;
            font-size: 24px;
        }
        .clear-btn {
            padding: 6px 12px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 15px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            color: white;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #555;
        }
        tr:hover {
            background-color: #333;
        }
        .action-btn {
            padding: 5px 10px;
            background-color: #0d6efd;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
        }
        .hangup-btn {
            background-color: #dc3545;
        }
        .message {
            padding: 10px;
            text-align: center;
            color: #aaa;
        }
    </style>
</head>
<body>
    <h2>通话管理系统</h2>
    
    <button class="clear-btn" onclick="clearCallHistory()">清空</button>
    
    <table>
        <thead>
            <tr>
                <th>#</th>
                <th>电话</th>
                <th>时间</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="callTableBody">
            <tr>
                <td colspan="4" class="message">加载数据中...</td>
            </tr>
        </tbody>
    </table>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // 获取DOM元素
        const callTableBody = document.getElementById('callTableBody');
        
        // 页面加载时获取通话记录
        document.addEventListener('DOMContentLoaded', () => {
            loadCallRecords();
            
            // 启动定时刷新
            setInterval(loadCallRecords, 10000); // 每10秒刷新一次
        });
        
        // 加载通话记录
        async function loadCallRecords() {
            try {
                const response = await fetch('/api/call-records', {
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache'
                    }
                });
                const records = await response.json();
                
                if (!records || records.length === 0) {
                    callTableBody.innerHTML = '<tr><td colspan="4" class="message">暂无通话记录</td></tr>';
                    return;
                }
                
                // 按时间戳降序排列
                records.sort((a, b) => b.timestamp - a.timestamp);
                
                let html = '';
                records.forEach((record, index) => {
                    html += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${record.phoneNumber || '未知号码'}</td>
                            <td>${record.time || new Date(record.timestamp).toLocaleString()}</td>
                            <td>
                                <button class="action-btn" onclick="answerCall('${record.phoneNumber}')">接通</button>
                                <button class="action-btn hangup-btn" onclick="hangupCall('${record.phoneNumber}')">挂断</button>
                            </td>
                        </tr>
                    `;
                });
                
                callTableBody.innerHTML = html;
            } catch (error) {
                console.error('加载通话记录失败:', error);
                callTableBody.innerHTML = '<tr><td colspan="4" class="message">加载失败</td></tr>';
            }
        }
        
        // 清空通话历史
        async function clearCallHistory() {
            if (!confirm('确定要清空所有通话记录吗？')) {
                return;
            }
            
            try {
                const response = await fetch('/api/clear-history', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    loadCallRecords();
                } else {
                    alert('清空失败: ' + (result.message || '未知错误'));
                }
            } catch (error) {
                console.error('清空通话记录失败:', error);
                alert('清空通话记录失败: ' + error.message);
            }
        }
        
        // 接通电话
        async function answerCall(phoneNumber) {
            try {
                // 找到对应的通话ID
                const response = await fetch('/api/calls');
                const calls = await response.json();
                
                const call = calls.find(c => c.phoneNumber === phoneNumber);
                if (!call) {
                    alert('找不到该号码的通话');
                    return;
                }
                
                const answerResponse = await fetch('/api/answer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ callId: call.callId })
                });
                
                if (answerResponse.ok) {
                    // 成功接通，刷新列表
                    setTimeout(loadCallRecords, 500);
                } else {
                    alert('接通失败');
                }
            } catch (error) {
                console.error('接通电话失败:', error);
                alert('接通电话失败: ' + error.message);
            }
        }
        
        // 挂断电话
        async function hangupCall(phoneNumber) {
            try {
                // 找到对应的通话ID
                const response = await fetch('/api/calls');
                const calls = await response.json();
                
                const call = calls.find(c => c.phoneNumber === phoneNumber);
                if (!call) {
                    alert('找不到该号码的通话');
                    return;
                }
                
                const hangupResponse = await fetch('/api/hangup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ callId: call.callId })
                });
                
                if (hangupResponse.ok) {
                    // 成功挂断，刷新列表
                    setTimeout(loadCallRecords, 500);
                } else {
                    alert('挂断失败');
                }
            } catch (error) {
                console.error('挂断电话失败:', error);
                alert('挂断电话失败: ' + error.message);
            }
        }
        
        // 设置socket连接
        let socket;
        try {
            socket = io();
            
            socket.on('connect', () => {
                console.log('Socket连接成功');
            });
            
            socket.on('call_status', (data) => {
                console.log('收到通话状态更新:', data);
                
                // 如果是新通话或通话结束，刷新列表
                if (data.status === 'ringing' || data.status === 'ended') {
                    setTimeout(loadCallRecords, 500);
                }
            });
            
            socket.on('connect_error', (error) => {
                console.error('Socket连接错误:', error);
            });
        } catch (error) {
            console.error('初始化Socket失败:', error);
        }
    </script>
</body>
</html> 