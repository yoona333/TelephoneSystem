<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>通话管理系统</title>
    <style>
        body {
            font-family: 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        h2 {
            color: #333;
            margin-bottom: 20px;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            color: white;
            font-weight: bold;
        }
        .btn-danger {
            background-color: #f44336;
        }
        .btn-success {
            background-color: #4CAF50;
        }
        .action-btn {
            padding: 5px 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .button-group {
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .message {
            padding: 10px;
            text-align: center;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>通话管理系统</h2>
        
        <div class="button-group">
            <button class="btn btn-danger" onclick="clearCallHistory()">清空</button>
            <button class="btn btn-success" onclick="loadCallRecords()">刷新</button>
        </div>
        
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>电话</th>
                    <th>时间</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="callTableBody">
                <tr>
                    <td colspan="4" class="message">加载数据中...</td>
                </tr>
            </tbody>
        </table>
    </div>

    <script>
        // 获取DOM元素
        const callTableBody = document.getElementById('callTableBody');
        
        // 页面加载时获取通话记录
        document.addEventListener('DOMContentLoaded', () => {
            loadCallRecords();
            
            // 启动定时刷新
            setInterval(loadCallRecords, 10000); // 每10秒刷新一次
        });
        
        // 加载通话记录
        async function loadCallRecords() {
            try {
                const response = await fetch('/api/call-records', {
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache'
                    }
                });
                const records = await response.json();
                
                if (!records || records.length === 0) {
                    callTableBody.innerHTML = '<tr><td colspan="4" class="message">暂无通话记录</td></tr>';
                    return;
                }
                
                // 按时间戳降序排列
                records.sort((a, b) => b.timestamp - a.timestamp);
                
                let html = '';
                records.forEach((record, index) => {
                    html += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${record.phoneNumber || '未知号码'}</td>
                            <td>${record.time || new Date(record.timestamp).toLocaleString()}</td>
                            <td>
                                <button class="action-btn" onclick="handleCall('${record.phoneNumber}')">操作</button>
                            </td>
                        </tr>
                    `;
                });
                
                callTableBody.innerHTML = html;
            } catch (error) {
                console.error('加载通话记录失败:', error);
                callTableBody.innerHTML = '<tr><td colspan="4" class="message">加载失败</td></tr>';
            }
        }
        
        // 清空通话历史
        async function clearCallHistory() {
            if (!confirm('确定要清空所有通话记录吗？')) {
                return;
            }
            
            try {
                const response = await fetch('/api/clear-history', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('通话记录已清空');
                    loadCallRecords();
                } else {
                    alert('清空失败: ' + (result.message || '未知错误'));
                }
            } catch (error) {
                console.error('清空通话记录失败:', error);
                alert('清空通话记录失败: ' + error.message);
            }
        }
        
        // 处理通话操作
        function handleCall(phoneNumber) {
            alert(`对电话 ${phoneNumber} 执行操作`);
        }
        
        // 设置socket连接（如果需要）
        let socket;
        try {
            // 如果页面上有socket.io.js，则使用socket
            if (typeof io !== 'undefined') {
                socket = io();
                
                socket.on('connect', () => {
                    console.log('Socket连接成功');
                });
                
                socket.on('call_status', (data) => {
                    console.log('收到通话状态更新:', data);
                    
                    // 如果是新通话或通话结束，刷新列表
                    if (data.status === 'ringing' || data.status === 'ended') {
                        setTimeout(loadCallRecords, 500);
                    }
                });
                
                socket.on('connect_error', (error) => {
                    console.error('Socket连接错误:', error);
                });
            }
        } catch (error) {
            console.error('初始化Socket失败:', error);
        }
    </script>
</body>
</html> 